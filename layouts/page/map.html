{{ define "body_class" }} post-template {{ end }}

{{ define "main" }}

{{- partial "header.html" . -}}

<main class="record">
    <article>
        <div class="dropdown-wrapper">
            <select id="yearFilter">
                <option value="all">Alle Jahre</option>
                {{ $pages := where .Site.RegularPages "Type" "default" }}
                {{ $years := slice }}
                {{ range $pages }}
                    {{ $dateStr := .Date.Format "2006" }}
                    {{ $years = $years | append $dateStr }}
                {{ end }}
                {{ $uniqueYears := sort (uniq $years) }}
                {{ range $uniqueYears }}
                <option value="{{ . }}">{{ . }}</option>
                {{ end }}
            </select>
        </div>
        <div class="container">
            <div class="box">
                <div id="mapid" style="height: 400px;"></div>
                <script>
                    var mapMarkers = [
                        {{ range $pages }}
                        {
                            "name": {{ .Title | jsonify }},
                            "latitude": {{ .Params.coordinates.latitude }},
                            "longitude": {{ .Params.coordinates.longitude }},
                            "marker_icon": {{ .Params.marker_icon | relURL }},
                            "url": {{ .Permalink }},
                            "year": "{{ .Date.Format "2006" }}"
                        },
                        {{ end }}
                    ];
                    var mapElement = document.getElementById('mapid');
                    if (mapElement) {
                        mapElement.dataset.markers = JSON.stringify(mapMarkers);
                    }

                    var map = L.map('mapid').setView([46.8, 8.23], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 20,
                        attribution: 'Â© OpenStreetMap'
                    }).addTo(map);
                    map.addControl(new L.Control.Fullscreen());

                    var allMarkers = [];
                    var markersData = JSON.parse(mapElement.dataset.markers);
                    markersData.forEach(function(marker) {
                        var customIcon = L.icon({
                            iconUrl: marker.marker_icon,
                            iconSize: [32, 32],
                            iconAnchor: [16, 32],
                            popupAnchor: [0, -32]
                        });
                        var markerInstance = L.marker([marker.latitude, marker.longitude], { icon: customIcon })
                            .bindPopup('<a href="' + marker.url + '">' + marker.name + '</a>');
                        allMarkers.push({ instance: markerInstance, year: marker.year });
                        markerInstance.addTo(map);
                    });

                    function filterMarkersByYear(selectedYear) {
                        allMarkers.forEach(function(markerData) {
                            if (selectedYear === "all" || markerData.year === selectedYear) {
                                map.addLayer(markerData.instance);
                            } else {
                                map.removeLayer(markerData.instance);
                            }
                        });
                    }

                    document.getElementById('yearFilter').addEventListener('change', function() {
                        filterMarkersByYear(this.value);
                    });

                    filterMarkersByYear("all");
                </script>
                <script src="/js/leaflet.js"></script>                
            </div>
        </div>
    </article>
</main>

{{ end }}
